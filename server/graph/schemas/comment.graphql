# ===============================================
# COMMENT
# ===============================================

extend type Query {
  comments: CommentQuery
}

extend type Mutation {
  comments: CommentMutation
}

# -----------------------------------------------
# QUERIES
# -----------------------------------------------

type CommentQuery {
  providers: [CommentProvider] @auth(requires: ["manage:system"])

  # Safe for non-admin clients.
  activeProviderKey: String! @auth(requires: ["read:comments"])

  list(
    locale: String!
    path: String!
  ): [CommentPost]! @auth(requires: ["read:comments"])

  single(
    id: Int!
  ): CommentPost @auth(requires: ["read:comments"])
}

# -----------------------------------------------
# MUTATIONS
# -----------------------------------------------

type CommentMutation {
  updateProviders(
    providers: [CommentProviderInput]
  ): DefaultResponse @auth(requires: ["manage:system"])

  create(
    pageId: Int
    pagePath: String
    pageLocale: String
    replyTo: Int
    content: String!
    selector: String
    selectedText: String
    guestName: String
    guestEmail: String
  ): CommentCreateResponse @auth(requires: ["write:comments"]) @rateLimit(limit: 1, duration: 15)

  update(
    id: Int!
    content: String!
  ): CommentUpdateResponse @auth(requires: ["manage:comments"])

  delete(
    id: Int!
  ): DefaultResponse @auth(requires: ["manage:comments"])

  vote(
    commentId: Int!
    voteType: CommentVoteType!
  ): CommentVoteResponse @auth(requires: ["write:comments"])

  removeVote(
    commentId: Int!
  ): CommentVoteResponse @auth(requires: ["write:comments"])
}

# -----------------------------------------------
# TYPES
# -----------------------------------------------

type CommentProvider {
  isEnabled: Boolean!
  key: String!
  title: String!
  description: String
  logo: String
  website: String
  isAvailable: Boolean
  config: [KeyValuePair]
}

input CommentProviderInput {
  isEnabled: Boolean!
  key: String!
  config: [KeyValuePairInput]
}

type CommentPost {
  id: Int!
  pagePath: String!
  content: String! @auth(requires: ["write:comments", "manage:comments", "manage:system"])
  render: String!
  selector: String
  selectedText: String
  replyTo: Int
  replyCount: Int!
  voteCounts: CommentVoteCounts!
  userVote: CommentVoteType
  authorId: Int!
  authorName: String!
  authorEmail: String! @auth(requires: ["manage:system"])
  authorIP: String! @auth(requires: ["manage:system"])
  createdAt: Date!
  updatedAt: Date!
}

enum CommentVoteType {
  upvote
  downvote
}

type CommentVoteCounts {
  upvotes: Int!
  downvotes: Int!
}

type CommentCreateResponse {
  responseResult: ResponseStatus
  id: Int
}

type CommentUpdateResponse {
  responseResult: ResponseStatus
  render: String
}

type CommentVoteResponse {
  responseResult: ResponseStatus
  voteCounts: CommentVoteCounts!
  userVote: CommentVoteType
}
